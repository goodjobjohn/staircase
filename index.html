<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Staircase</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <button type="button" name="add-list" value="add list here">+</button>
  <div class="lists">
    <div class="list">
      <h2 class="title" contenteditable="true">STAIRCASE</h2>
      <p></p>
      <ul class="plates">
        <li>Start your list....</li>
      </ul>
      <form class="add-items">
        <input type="text" name="item" placeholder="Item Name" required>
        <input type="submit" value="+ Add Item">
        <button type="button" name="clear">Clear</button>
        <button type="button" name="check">Check</button>
        <button type="button" name="uncheck">Uncheck</button>
      </form>
    </div>
    <p></p>

  </div>

<script>

  // declare vars
  const lists = document.querySelector('.lists');
  const addList = document.querySelector('[name=add-list]');
  const addItems = document.querySelector('.add-items');
  const itemsList = document.querySelector('.plates');
  let items = JSON.parse(localStorage.getItem('items')) || [];
  
  const titleClass = document.querySelector('.title');
  let titleVar = JSON.parse(localStorage.getItem('titleVar')) || [];

  // buttons
  const clear = addItems.querySelector('[name=clear]');
  const check = addItems.querySelector('[name=check]');
  const uncheck = addItems.querySelector('[name=uncheck]');

  const listHTML = `<div class="list">
                      <h2 class="title" contenteditable="true">STAIRCASE</h2>
                      <li>
                        <div class="item-text" contenteditable="true">this is an item</div>
                        <div class="check-item"></div><div class="delete-item"></div>
                      </li>
                      <div class="new-item">+</div>
                    </div>
                    `;

  // FUNCTIONS

  function addItem(e) {
    e.preventDefault(); // Stop page reloading on submit
    const text = (this.querySelector('[name=item]')).value;
    const item = {
      text,
      done: false
    }
    items.push(item);
    localStorage.setItem('items', JSON.stringify(items));
    populateList(items, itemsList);
    
    this.reset(); // clear text input

  }

  function populateList(items = [], itemsList) {
    itemsList.innerHTML = items.map((item, i ) => {
      return `
      <li>
          <input type="checkbox" data-index=${i} id="item${i}" ${item.done ? 'checked' : ''} />
          <label for="item${i}">${item.text}</label><button type="button" name="delete">X</button>
      </li>
      `;
    }).join(''); // removes the comma between each index

    titleClass.innerHTML = titleVar;
  }

  function itemFunction(e) {
    // store event target so it can be passed to other functions
    const target = event.target;
    // console.log(target);
    // check to see if click event is an input
    if (target.matches('input')) toggleChecked(target);
    
    // check to see if click event is a button
    if (target.matches('button')) deleteItem(target);
  }

  function toggleChecked(target) {
    const el = target;
    const index = el.dataset.index;
    //console.log(el);
    items[index].done = !items[index].done;
    localStorage.setItem('items', JSON.stringify(items));
    populateList(items,itemsList);
  }

  function deleteItem(target) {
    const el = target;
    // recover index no. of item (input)
    const deleteItem = el.parentNode.querySelector('[type=checkbox]').dataset.index;

    // remove item using .splice and index number(deleteNumber) from lists array
    items.splice(deleteItem, 1);
    
    // remove item from localStorage
    localStorage.setItem('items', JSON.stringify(items));
    
    // rebuild altered list in html
    populateList(items,itemsList);
  
  }

  function clearList(e) {
    // clear all html
    itemsList.innerHTML = '';
    // clear localstorage
    localStorage.clear();
    // clear list object
    items = [];
  }

  function checkList(e) {
    // query all inputs and turn nodeList into array
    const inputs = [...itemsList.querySelectorAll('input')];
    
    // check all inputs
    inputs.map(input => input.setAttribute('checked', 'checked'));
    
    // localStorage: set all items dataset > data-done: 'true' 
    items.map(item => item.done = true );    
    localStorage.setItem('items', JSON.stringify(items));
  }

  function uncheckList(e) {
    // query all inputs and turn nodeList into array
    const inputs = [...itemsList.querySelectorAll('input')];
    
    // uncheck all inputs
    inputs.map(input => input.removeAttribute('checked'));

    // localStorage: set all items dataset > data-done: 'true' 
    items.map(item => item.done = false );    
    localStorage.setItem('items', JSON.stringify(items));
  }

  function storeTitle(e) {
    // query title 
    const titleVar = e.target.innerHTML;
    
    // store title locally
    localStorage.setItem('titleVar', JSON.stringify(titleVar));
  }

  // EVENT LISTENERS 

  addItems.addEventListener('submit', addItem);
  itemsList.addEventListener('click', itemFunction);
  clear.addEventListener('click', clearList);
  check.addEventListener('click', checkList);
  uncheck.addEventListener('click', uncheckList);
  titleClass.addEventListener('focusout', storeTitle);

  populateList(items, itemsList);

  // STAIRCASE VARIABLES

  let myBigObject = JSON.parse(localStorage.getItem('myBigObject')) || [];
  const newItemHTML = `<li>
                        <div class="item-text" contenteditable="true"></div>
                        <div class="check-item"></div><div class="delete-item"></div>
                    </li>`;
  const titleFocus = document.querySelectorAll('.title');
  let lastTitle = titleFocus[titleFocus.length- 1]; // Need to learn how this works 
  
  // STAIRCASE - FUNCTIONS

  function addListOnClick(e) {
    lists.insertAdjacentHTML('beforeend', listHTML);
    //lists.lastChild.querySelector('.title').focus();
    const lastListInNode = lists.lastElementChild;
    lastListInNode.querySelector('.title').focus();
    console.log(lastListInNode);
    //let lastTitle = titleFocus[titleFocus.length- 1];
  }

  function saveTitleOnUnfocus(e) {
    // query title 
    const title = e.target.innerHTML;
    console.log(title);
    // store title locally
    // localStorage.setItem('titleVar', JSON.stringify(titleVar));
  }
  
  // a click anywhere inside .lists triggers this function
  // here we identify the click event target and call the correct function
  function listClickEvent(e) {
    // query list title
    // const list = e.target.parentNode.querySelector('.title').innerHTML;
    const click = e.target;
    //console.log(e.target);
    
    // Check Item: Delete in future
    if (e.target.matches('[type=checkbox]')) {
      console.log('check item');
    } 
    // Check Item 
    if (e.target.matches('.check-item')) {
      console.log('check list item');
    } 
    
    // Delete Item
    if (e.target.matches('.delete-item')) {
      console.log('DELETE item');
      e.target.parentNode.remove();
    } 
      
    // Add new item to list
    if (e.target.matches('.new-item')) {
      console.log(e.target.previousSibling)
      e.target.insertAdjacentHTML('beforebegin', newItemHTML);
      e.target.previousSibling.querySelector('.item-text').focus();
      
    }

    //if (e.target.matches.)
    // delete item from list

    // check item on list
    
    // if e.target == title continue with title as list 
  }
  
  // STAIRCASE - EVENT LISTENERS

  // add new list button click
  addList.addEventListener('click', addListOnClick);
  // any click inside .lists
  lists.addEventListener('click', listClickEvent);
  lastTitle.addEventListener('focusout', saveTitleOnUnfocus);

  
</script>


</body>
</html>

